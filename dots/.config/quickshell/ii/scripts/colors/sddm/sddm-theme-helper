#!/bin/bash
# SDDM wallpaper and color updater - runs with elevated privileges
# This script is called by matugen/switchwall automatically

SDDM_THEME_DIR="/usr/share/sddm/themes/sugar-candy"
SDDM_BG_DIR="$SDDM_THEME_DIR/Backgrounds"
THEME_CONF="$SDDM_THEME_DIR/theme.conf"
# Detect the real invoking user (works with sudo and pkexec)
if [ -n "$SUDO_USER" ]; then
    REAL_USER="$SUDO_USER"
elif [ -n "$PKEXEC_UID" ]; then
    REAL_USER="$(getent passwd "$PKEXEC_UID" | cut -d: -f1)"
else
    REAL_USER="$(logname 2>/dev/null || echo "$USER")"
fi
REAL_HOME=$(getent passwd "$REAL_USER" | cut -d: -f6)
USER_COLORS="$REAL_HOME/.config/sddm/theme.conf"
# Log which user/home/colors file will be used for debugging
logger -t sddm-theme-helper "Running as $REAL_USER (home: $REAL_HOME), user colors: $USER_COLORS"

ACTION="$1"
shift

trim() { echo "$1" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//'; }

update_conf_key() {
    local key="$1" value="$2" key_esc value_esc
    key="$(trim "$key")"
    value="$(trim "$value")"
    key_esc=$(printf '%s' "$key" | sed 's/[\/&]/\\&/g')
    value_esc=$(printf '%s' "$value" | sed 's/[\/&]/\\&/g')
    if grep -q -E "^[[:space:]]*$key_esc=" "$THEME_CONF" 2>/dev/null; then
        sed -i "s|^[[:space:]]*$key_esc=.*|$key=$value_esc|" "$THEME_CONF"
    else
        echo "$key=$value" >> "$THEME_CONF"
    fi
}

case "$ACTION" in
    set-wallpaper)
        WALLPAPER_PATH="$1"
        if [ -z "$WALLPAPER_PATH" ] || [ ! -f "$WALLPAPER_PATH" ]; then
            echo "Error: Invalid wallpaper path: $WALLPAPER_PATH"
            exit 1
        fi
        
        # Ensure the background directory exists
        if [ ! -d "$SDDM_BG_DIR" ]; then
            mkdir -p "$SDDM_BG_DIR"
        fi
        
        # Copy wallpaper to SDDM backgrounds dir
        FILENAME="current-wallpaper.${WALLPAPER_PATH##*.}"
        logger -t sddm-theme-helper "Copying wallpaper '$WALLPAPER_PATH' to '$SDDM_BG_DIR/$FILENAME'"
        # Use install to set mode atomically and avoid race conditions
        if install -m 0644 "$WALLPAPER_PATH" "$SDDM_BG_DIR/$FILENAME"; then
            # Ensure ownership and permissions are sane
            chown root:root "$SDDM_BG_DIR/$FILENAME" 2>/dev/null || true
            logger -t sddm-theme-helper "Copied wallpaper to $SDDM_BG_DIR/$FILENAME"
        else
            logger -t sddm-theme-helper "Failed to copy wallpaper: $WALLPAPER_PATH -> $SDDM_BG_DIR/$FILENAME"
            exit 1
        fi
        # Update theme.conf to use this wallpaper (quoted for sugar-candy compatibility)
        if [ -f "$THEME_CONF" ]; then
            if grep -q "^[[:space:]]*Background=" "$THEME_CONF"; then
                sed -i "s|^[[:space:]]*Background=.*|Background=\"Backgrounds/$FILENAME\"|" "$THEME_CONF"
            else
                echo "Background=\"Backgrounds/$FILENAME\"" >> "$THEME_CONF"
            fi
        else
            echo "[General]" > "$THEME_CONF"
            echo "Background=\"Backgrounds/$FILENAME\"" >> "$THEME_CONF"
        fi
        # Log final state for debugging
        logger -t sddm-theme-helper "Wallpaper set to $FILENAME; destination perms: $(ls -l "$SDDM_BG_DIR/$FILENAME" 2>/dev/null || echo 'not found')"
        logger -t sddm-theme-helper "Theme Background line: $(grep -n "^[[:space:]]*Background=" "$THEME_CONF" 2>/dev/null || echo 'none')"
        echo "SDDM wallpaper updated: $FILENAME"
        ;;
    
    set-colors)
        if [ ! -f "$USER_COLORS" ]; then
            echo "No color file found at $USER_COLORS"
            exit 0
        fi
        
        # Check if sugar-candy theme is installed
        if [ ! -d "$SDDM_THEME_DIR" ]; then
            echo "Sugar Candy theme not installed at $SDDM_THEME_DIR"
            exit 0
        fi
        
        # Ensure [General] section exists
        if [ ! -f "$THEME_CONF" ]; then
            echo "[General]" > "$THEME_CONF"
        fi
        
        # Read colors and update theme.conf
        while IFS="=" read -r key value; do
            [[ "$key" =~ ^[[:space:]]*# ]] && continue
            [[ "$key" =~ ^\[.*\]$ ]] && continue
            [[ -z "$key" ]] && continue
            key="$(trim "$key")"
            value="$(trim "$value")"
            if [ -n "$key" ] && [ -n "$value" ]; then
                update_conf_key "$key" "$value"
            fi
        done < "$USER_COLORS"
        echo "SDDM colors updated from $USER_COLORS"
        ;;
    
    update-all)
        # Update both wallpaper and colors
        WALLPAPER_PATH="$1"
        
        # Update colors first
        if [ -f "$USER_COLORS" ] && [ -d "$SDDM_THEME_DIR" ]; then
            if [ ! -f "$THEME_CONF" ]; then
                echo "[General]" > "$THEME_CONF"
            fi
            
            while IFS="=" read -r key value; do
                [[ "$key" =~ ^[[:space:]]*# ]] && continue
                [[ "$key" =~ ^\[.*\]$ ]] && continue
                [[ -z "$key" ]] && continue
                key="$(trim "$key")"
                value="$(trim "$value")"
                if [ -n "$key" ] && [ -n "$value" ]; then
                    update_conf_key "$key" "$value"
                fi
            done < "$USER_COLORS"
            echo "SDDM colors updated"
        fi
        
        # Update wallpaper if provided and valid
        if [ -n "$WALLPAPER_PATH" ] && [ -f "$WALLPAPER_PATH" ]; then
            if [ ! -d "$SDDM_BG_DIR" ]; then
                mkdir -p "$SDDM_BG_DIR"
            fi
            
            FILENAME="current-wallpaper.${WALLPAPER_PATH##*.}"
            logger -t sddm-theme-helper "Copying wallpaper '$WALLPAPER_PATH' to '$SDDM_BG_DIR/$FILENAME' (update-all)"
            if install -m 0644 "$WALLPAPER_PATH" "$SDDM_BG_DIR/$FILENAME"; then
                chown root:root "$SDDM_BG_DIR/$FILENAME" 2>/dev/null || true
                logger -t sddm-theme-helper "Copied wallpaper to $SDDM_BG_DIR/$FILENAME"
            else
                logger -t sddm-theme-helper "Failed to copy wallpaper (update-all): $WALLPAPER_PATH -> $SDDM_BG_DIR/$FILENAME"
            fi
            
            if grep -q "^[[:space:]]*Background=" "$THEME_CONF" 2>/dev/null; then
                sed -i "s|^[[:space:]]*Background=.*|Background=\"Backgrounds/$FILENAME\"|" "$THEME_CONF"
            else
                echo "Background=\"Backgrounds/$FILENAME\"" >> "$THEME_CONF"
            fi
            logger -t sddm-theme-helper "Wallpaper set to $FILENAME; destination perms: $(ls -l "$SDDM_BG_DIR/$FILENAME" 2>/dev/null || echo 'not found')"
            echo "SDDM wallpaper updated: $FILENAME"
        fi
        ;;
    *)
        echo "Usage: $0 {set-wallpaper <path>|set-colors|update-all [wallpaper_path]}"
        exit 1
        ;;
esac
